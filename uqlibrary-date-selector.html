<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="uqlibrary-time-selector.html">

<!--

Custom web element displays a provided date and time schedule with ability to select time slots

##### Example

    <uqlibrary-date-selector></uqlibrary-date-selector>

     <script>
      (function () {

        window.addEventListener('polymer-ready', function() {
            var date_selector = document.querySelector('uqlibrary-date-selector');

            date_selector.searchDate = new Date(new Date().getTime() + 2 * 24 * 60 * 60 * 1000);
            date_selector.maxBookingDate = new Date(new Date().getTime() + 7 * 24 * 60 * 60 * 1000);
            date_selector.maxBookingLength = 4;
            date_selector.bookingTimeslots = [
                {
                    startTime : '8:00 am',
                    selectable: true,
                    selected: false
                },
                {
                    startTime : '8:30 am',
                    selectable: true,
                    selected: false
                }
            ];
            }());
    </script>

@element uqlibrary-date-selector
@blurb Custom web element displays a provided date and time schedule with ability to select time slots
@status alpha
@homepage http://uqlibrary.github.io/uqlibrary-date-selector

-->
<polymer-element name="uqlibrary-date-selector" attributes="searchDate maxBookingDate bookingTimeslots maxBookingLength">

  <template>

    <link rel="stylesheet" href="uqlibrary-date-selector.css">

    <paper-tabs id="items" selected="{{ selectedDateIndex }}" on-core-select = "{{ dateSelected }}" scrollable>
      <template repeat="{{date, index in dates}}">

        <paper-tab class="item" data-index="{{ index }}" data-value=" {{ date }}">
          {{  date  | dayOfWeek  }},<br/>
          {{  date  | formatDate  }}
        </paper-tab>

      </template>
    </paper-tabs>

    <uqlibrary-time-selector id="timeSelector" maxBookingLength="{{ maxBookingLength}} "></uqlibrary-time-selector>

  </template>


  <script>

    Polymer({
    /**
     * The `searchDate` attribute date for which to display time slots
     *
     * @property searchDate
     * @type Date
     */

    /**
     * The `maxBookingDate` attribute date indicates maximum possible booking date
     *
     * @property maxBookingDate
     * @type Date
     */

     /**
      *  The `bookingTimeslots` attribute object contains time slots for selected search date
      *
      * @property bookingTimeslots
      * @type Object
      */

      /**
       *  The `maxBookingLength` attribute is an int indicates maximum number of time slots per booking
       *
       * @property maxBookingLength
       * @type Int
       */

      formatDate : function (date) {
        return '' + date.getDate() + " " + this.monthNames[date.getMonth()];
      },

      dayOfWeek : function (date) {
        return '' + this.dayNames[date.getDay()];
      },

      maxBookingDateChanged : function (oldValue, newValue) {
        this.generateDates();
        this.selectedDateIndex = this.dates.map(function(date) {return date.toDateString(); }).indexOf(this.searchDate.toDateString());
      },

      searchDateChanged : function (oldValue, newValue) {
        this.selectedDateIndex = this.dates.map(function(date) {return date.toDateString(); }).indexOf(this.searchDate.toDateString());
      },

      bookingTimeslotsChanged : function(oldValue, newValue){
        this.$.timeSelector.bookingTimeslots = this.bookingTimeslots;
      },

      dateSelected : function(event) {

        if (event.detail.isSelected
            && this.searchDate.toDateString() !== this.dates[this.$.items.selected].toDateString()) {
          this.searchDate = this.dates[this.$.items.selected];
        }

      },

      created: function() {
        this.ticksPerDay = 24 * 60 * 60 * 1000;
        this.dayNames = [
          'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'
        ];
        this.monthNames = [
          'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
        ];

        this.searchDate = new Date();
        this.maxBookingDate = new Date(this.searchDate.getTime() + 7 * this.ticksPerDay);
        this.dates = [];
        this.bookingTimeslots = [];
        this.maxBookingLength = 0;

        this.generateDates();
      },

      generateDates: function() {
        var today = new Date();

        var timeDiff = Math.abs(today.getTime() - this.maxBookingDate.getTime());
        var diffDays = Math.ceil(timeDiff / this.ticksPerDay);

        this.dates = [];

        for(var i=0; i < diffDays; i++) {
          this.dates.push(new Date(today.getTime() + i * this.ticksPerDay));
        }
      }

    });

  </script>

</polymer-element>
